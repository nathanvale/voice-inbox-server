name: Auto-generate Changeset (PR)

on:
  pull_request:
    types: [opened, synchronize, edited, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 8
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Detect existing changeset
        id: detect
        shell: bash
        run: ./.github/scripts/changeset-detect-existing.sh .changeset
      - name: Setup Bun
        uses: ./.github/actions/setup-bun
      - name: Install deps (minimal)
        run: bun install --frozen-lockfile --ignore-scripts
      - name: Generate changeset if missing
        if: steps.detect.outputs.found == '0'
        shell: bash
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: ./.github/scripts/changeset-generate-if-missing.sh
      - name: Annotate PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const missing = '${{ steps.detect.outputs.found }}' === '0'
            const body = missing ? 'Auto-generated a changeset for this PR.' : 'Changeset already present.'
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            })
